<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciar Sesión - Karts</title>
</head>
<body>

    <h1>Acceso a Usuarios</h1>
    <hr>

    <div id="error-box" style="color: red; display: none; margin-bottom: 15px;"></div>

    <form id="login-form">
        <fieldset>
            <legend>Credenciales</legend>
            
            <label for="email">Correo Electrónico:</label><br>
            <input type="email" id="email" name="email" required placeholder="ejemplo@correo.com" style="width: 250px;">
            <br><br>

            <label for="password">Contraseña:</label><br>
            <input type="password" id="password" name="password" required style="width: 250px;">
            <br><br>

            <button type="submit" id="btn-submit" style="padding: 10px 20px; cursor: pointer;">INICIAR SESIÓN</button>
        </fieldset>
    </form>

    <p><small>¿No tienes cuenta? <a href="#">Regístrate aquí</a></small></p>

<script>
    /**
     * CONFIGURACIÓN
     * Apunta al servidor Backend real de tu equipo.
     */
    const API_URL = 'http://localhost:3000/api/auth/login';

    // Elementos del DOM
    const loginForm = document.getElementById('login-form');
    const errorBox = document.getElementById('error-box');
    const btnSubmit = document.getElementById('btn-submit');

    /**
     * LÓGICA DE INICIO DE SESIÓN
     */
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault(); // Evita que se recargue la página

        // 1. Obtener datos
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        // 2. Limpiar errores y bloquear botón
        hideError();
        btnSubmit.disabled = true;
        btnSubmit.textContent = "Cargando...";

        try {
            // 3. Petición al Backend (REAL)
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email, password })
            });

            // 4. Verificar respuesta
            if (!response.ok) {
                // Si el servidor dice "401 Unauthorized" o similar
                const data = await response.json();
                throw new Error(data.message || 'Usuario o contraseña incorrectos');
            }

            const data = await response.json();

            // 5. ÉXITO: Guardar sesión y REDIRIGIR
            // Guardamos el token para usarlo en las reservas
            localStorage.setItem('authToken', data.token);
            localStorage.setItem('userData', JSON.stringify(data.user));

            // Redirección automática a la página de reservas
            window.location.href = 'reserva.html';

        } catch (error) {
            // 6. Manejo de Errores
            let msg = error.message;
            if (msg === 'Failed to fetch') {
                msg = "No se puede conectar con el servidor. Inténtalo más tarde.";
            }
            showError(msg);
            
            // Restaurar botón
            btnSubmit.disabled = false;
            btnSubmit.textContent = "INICIAR SESIÓN";
        }
    });

    // Funciones visuales auxiliares
    function showError(message) {
        errorBox.textContent = "⚠️ " + message;
        errorBox.style.display = 'block';
    }

    function hideError() {
        errorBox.style.display = 'none';
        errorBox.textContent = "";
    }

    /**
     * VERIFICACIÓN AUTOMÁTICA
     * Si ya estás logueado, te manda directo a reserva.html
     */
    window.addEventListener('load', () => {
        const token = localStorage.getItem('authToken');
        if (token) {
            // Si quieres que el login sea persistente, descomenta la siguiente línea:
            // window.location.href = 'reserva.html';
        }
    });

</script>
</body>
</html>