<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reserva Karts - Sin Estilos</title>
    <link rel="stylesheet" href="./src/index.css">
</head>
<body>

    <h1>Sistema de Reserva de Carreras (KARTS-RF-003)</h1>
    <hr>

    <div id="status-message" style="color: red;"></div>

    <form id="booking-form">
        
        <fieldset>
            <legend>1. Selección de Pista</legend>
            <label for="track-select">Elige el circuito:</label><br>
            <select id="track-select" required>
                <option value="">Cargando datos del servidor...</option>
            </select>
        </fieldset>
        <br>

        <fieldset>
            <legend>2. Selección de Fecha</legend>
            <label for="date-select">Fecha deseada:</label><br>
            <input type="date" id="date-select" required disabled>
        </fieldset>
        <br>

        <fieldset>
            <legend>3. Horarios Disponibles</legend>
            <p id="slots-loading-text">Selecciona una pista y una fecha para ver horarios.</p>
            
            <div id="slots-container"></div>
        </fieldset>
        <br>

        <button type="submit" id="btn-submit" disabled>CONFIRMAR Y PAGAR</button>
    </form>

    <hr>
    <h3>Datos de Depuración (Log):</h3>
    <pre id="debug-log">Esperando acciones...</pre>

<script>
    /**
     * CONFIGURACIÓN
     * Apunta a tu servidor Backend real.
     */
    const API_BASE_URL = 'http://localhost:3000/api/v1'; 

    // Referencias al DOM
    const ui = {
        trackSelect: document.getElementById('track-select'),
        dateSelect: document.getElementById('date-select'),
        slotsContainer: document.getElementById('slots-container'),
        slotsLoadingText: document.getElementById('slots-loading-text'),
        btnSubmit: document.getElementById('btn-submit'),
        statusMsg: document.getElementById('status-message'),
        debugLog: document.getElementById('debug-log'),
        form: document.getElementById('booking-form')
    };

    /**
     * FUNCIÓN 1: INICIALIZACIÓN
     * Carga las pistas al abrir la página.
     */
    async function init() {
        log("Iniciando aplicación...");
        try {
            const response = await fetch(`${API_BASE_URL}/tracks`);
            if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
            
            const tracks = await response.json();
            
            // Limpiar y llenar select
            ui.trackSelect.innerHTML = '<option value="">-- Seleccionar --</option>';
            tracks.forEach(track => {
                const option = document.createElement('option');
                option.value = track.id;
                option.textContent = `${track.name} (Precio: $${track.price})`;
                ui.trackSelect.appendChild(option);
            });

            ui.dateSelect.disabled = false;
            log("Pistas cargadas correctamente.");

        } catch (error) {
            showError("No se pudo conectar al Backend. Revisa la consola.");
            console.error(error);
        }
    }

    /**
     * FUNCIÓN 2: CONSULTAR DISPONIBILIDAD
     */
    async function checkAvailability() {
        const trackId = ui.trackSelect.value;
        const dateVal = ui.dateSelect.value;

        // Resetear UI
        ui.slotsContainer.innerHTML = '';
        ui.btnSubmit.disabled = true;

        if (!trackId || !dateVal) return;

        ui.slotsLoadingText.textContent = "Consultando servidor...";
        log(`Buscando horarios para Pista ${trackId} en fecha ${dateVal}...`);

        try {
            const response = await fetch(`${API_BASE_URL}/availability?track_id=${trackId}&date=${dateVal}`);
            if (!response.ok) throw new Error('Fallo al obtener horarios');

            const slots = await response.json();
            renderSlots(slots);

        } catch (error) {
            showError("Error al cargar disponibilidad.");
            ui.slotsLoadingText.textContent = "Error de conexión.";
        }
    }

    /**
     * FUNCIÓN 3: RENDERIZAR RADIO BUTTONS (Sin CSS)
     * Usamos inputs nativos para la selección.
     */
    function renderSlots(slots) {
        if (slots.length === 0) {
            ui.slotsLoadingText.textContent = "No hay huecos libres para esta fecha.";
            return;
        }

        ui.slotsLoadingText.textContent = "Seleccione un horario de la lista:";

        // Crear una lista desordenada nativa
        const list = document.createElement('ul');

        slots.forEach(slot => {
            const item = document.createElement('li');
            
            // Lógica para slots ocupados vs libres
            if (slot.is_reserved) {
                // Texto simple tachado o indicando ocupado
                item.innerHTML = `<del>${slot.time}</del> (Ocupado)`;
                item.style.color = 'gray'; // Unico estilo inline permitido por legibilidad
            } else {
                // Radio button nativo
                const label = document.createElement('label');
                const radio = document.createElement('input');
                
                radio.type = 'radio';
                radio.name = 'slot_selection'; // Importante: mismo nombre para agrupación
                radio.value = slot.id;
                
                // Evento para habilitar botón pagar
                radio.addEventListener('change', () => {
                    ui.btnSubmit.disabled = false;
                    log(`Usuario seleccionó horario ID: ${slot.id}`);
                });

                label.appendChild(radio);
                label.appendChild(document.createTextNode(` ${slot.time}`));
                item.appendChild(label);
            }

            list.appendChild(item);
        });

        ui.slotsContainer.appendChild(list);
    }

    /**
     * FUNCIÓN 4: PROCESAR RESERVA (SUBMIT)
     */
    ui.form.addEventListener('submit', async (e) => {
        e.preventDefault();

        // Obtener el radio button seleccionado
        const selectedRadio = document.querySelector('input[name="slot_selection"]:checked');
        if (!selectedRadio) return alert("Por favor selecciona un horario.");

        const payload = {
            track_id: ui.trackSelect.value,
            date: ui.dateSelect.value,
            slot_id: selectedRadio.value
        };

        ui.btnSubmit.textContent = "Enviando datos...";
        ui.btnSubmit.disabled = true;
        log("Enviando POST a /bookings...");

        try {
            const response = await fetch(`${API_BASE_URL}/bookings`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (!response.ok) throw new Error(data.message || 'Error al reservar');

            // Éxito
            log("Reserva Exitosa: " + data.booking_code);
            alert(`¡CONFIRMADO!\n\nTu código es: ${data.booking_code}\nGuárdalo para entrar.`);
            location.reload();

        } catch (error) {
            showError(error.message);
            ui.btnSubmit.textContent = "CONFIRMAR Y PAGAR";
            ui.btnSubmit.disabled = false;
        }
    });

    // Helpers
    function showError(msg) {
        ui.statusMsg.textContent = "⚠️ " + msg;
    }
    
    function log(msg) {
        const time = new Date().toLocaleTimeString();
        ui.debugLog.textContent += `\n[${time}] ${msg}`;
    }

    // Listeners
    ui.trackSelect.addEventListener('change', checkAvailability);
    ui.dateSelect.addEventListener('change', checkAvailability);

    // Arrancar
    init();

</script>
</body>
</html>